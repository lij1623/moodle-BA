/**
 * @module      editor_marklar2/editor
 * @package     editor_marklar2
 * @copyright   2016 David Mudrak <david@moodle.com>
 * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("editor_marklar2/editor",["jquery","core/yui","core/str","core/log","core/ajax","core/event","editor_marklar2/filepicker","editor_marklar2/imagepaster"],(function($,Y,str,log,ajax,event,filepicker,ImagePaster){function MarklarEditor(textarea,initparams){this.initparams=initparams,void 0!==M.editor_marklar2.fpoptions[initparams.elementid]&&(this.initparams.filepickeroptions=M.editor_marklar2.fpoptions[initparams.elementid]),this.initTextArea(textarea),this.initPanel(),this.initFilesEmbedding(),this.initSyntaxHelp(),this.initImagePaster()}return MarklarEditor.prototype.initTextArea=function(textarea){this.textarea=textarea.addClass("marklar-textarea").addClass("button").css("box-sizing","border-box").css("width","100%").css("background-color","#ADD8E6").css("margin-bottom","10px").css("padding","7px")},MarklarEditor.prototype.initPanel=function(){this.textarea.wrap('<div class="marklar-wrapper"></div>'),this.panel=$('<div class="marklar-panel"></div>').insertAfter(this.textarea),this.editpanel=$('<div class="marklar-edit-panel"></div>').appendTo(this.panel),this.editpanel.append('<span data-marklar-placeholder="syntax" />'),this.editpanel.append('<span data-marklar-placeholder="insert-image" />'),this.editpanel.append('<span data-marklar-placeholder="insert-file" />')},MarklarEditor.prototype.initFilesEmbedding=function(){if("filepickeroptions"in this.initparams){var self=this;Y.use("core_filepicker",(function(){self.filepicker=filepicker.init(self.initparams.filepickeroptions),self.filepicker.canShowFilepicker("image")&&str.get_string("insertimage","editor_marklar2").done((function(strinsertimage){var button=$('<button class="btn btn-default" data-marklar-widget="insert-image" />');button.text(strinsertimage),button.click((function(e){e.preventDefault(),self.filepicker.showFilepicker("image",(function(data){self.imageEmbedded(data)}))})),self.panel.find('[data-marklar-placeholder="insert-image"]').replaceWith(button),self.insertImageButton=button})),self.filepicker.canShowFilepicker("link")&&str.get_string("insertlink","editor_marklar2").done((function(strinsertlink){var button=$('<button class="btn btn-default" data-marklar-widget="insert-file" />');button.text(strinsertlink),button.click((function(e){e.preventDefault(),self.filepicker.showFilepicker("link",(function(data){self.insertLink(data)}))})),self.panel.find('[data-marklar-placeholder="insert-file"]').replaceWith(button),self.insertFileButton=button}))}))}else log.error(this.initparams.elementid+": File picker options not found")},MarklarEditor.prototype.imageEmbedded=function(data){"url"in data&&this.insertText('<img alt="" class="img-responsive" src="'+data.url+'"/>')},MarklarEditor.prototype.insertLink=function(data){var texttoshow;"url"in data&&(texttoshow="file"in data&&data.file?data.file.replace(/(\[|\])/g,"_"):"texttoshow",this.insertText("["+texttoshow+"]("+data.url+")"))},MarklarEditor.prototype.insertText=function(inserttext){var areatext=this.textarea.val(),selectionStart=this.textarea.prop("selectionStart"),selectionEnd=this.textarea.prop("selectionEnd");this.textarea.val(areatext.substring(0,selectionStart)+inserttext+areatext.substring(selectionEnd))},MarklarEditor.prototype.initSyntaxHelp=function(){var self=this;return self.syntaxBody=$('<div class="marklar-syntax-help" />').hide(),self.editpanel.append(self.syntaxBody),str.get_strings([{key:"syntaxon",component:"editor_marklar2"},{key:"syntaxoff",component:"editor_marklar2"}]).then((function(strings){self.syntaxButtonOn=$('<button class="btn btn-link" data-marklar-widget="syntax-on" />').text(strings[0]).on("click",self.syntaxOn.bind(self)),self.syntaxButtonOff=$('<button class="btn btn-link" data-marklar-widget="syntax-off" />').text(strings[1]).on("click",self.syntaxOff.bind(self)).hide();var buttonSyntax=$('<div class="marklar-syntax-controls" />').append(self.syntaxButtonOn).append(self.syntaxButtonOff);return self.panel.find('[data-marklar-placeholder="syntax"]').replaceWith(buttonSyntax),!0})).catch((function(err){return log.error(err),!1})),self.formatSelector&&self.formatSelector.on("change",(function(){self.syntaxBody.is(":visible")&&self.syntaxButtonOn.click()})),!0},MarklarEditor.prototype.initImagePaster=function(){this.initparams.filepickeroptions.image&&ImagePaster.init(this.textarea,this.initparams.filepickeroptions.image,this.imageEmbedded.bind(this))},MarklarEditor.prototype.syntaxOn=function(e){var self=this;return e.preventDefault(),str.get_string("syntaxloading","editor_marklar2").then((function(strsyntaxloading){return self.syntaxButtonOn.hide(),self.syntaxButtonOff.show(),self.syntaxBody.html('<div class="marklar-syntax-loading">'+strsyntaxloading+"</div>"),self.syntaxBody.show(),self.syntaxLoad(),!0}))},MarklarEditor.prototype.syntaxOff=function(e){e.preventDefault(),this.syntaxButtonOff.hide(),this.syntaxButtonOn.show(),this.syntaxBody.hide(),this.syntaxBody.html("")},MarklarEditor.prototype.syntaxLoad=function(){var self=this;return str.get_string("syntax-format"+self.formatSelector.val(),"editor_marklar2").then((function(strsyntax){self.syntaxBody.html(strsyntax)}))},{init:function(params){var textarea;if(!("elementid"in params))throw new Error("editor_markla2: Invalid editor init parameter - missing elementid");if((textarea=$(document.getElementById(params.elementid))).length)return new MarklarEditor(textarea,params);throw new Error("Unable to find textarea element",params.elementid)}}}));

//# sourceMappingURL=editor.min.js.map